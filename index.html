<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MemeLee — The Perfect Edition</title>
<!-- Added Specific Meme Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Impact&family=Montserrat:wght@900&display=swap" rel="stylesheet">
<style>
:root{
  --bg: linear-gradient(180deg,#0f1720,#0b1220);
  --panel: rgba(255,255,255,0.04);
  --accent: #f27121;
  --gradient-btn: linear-gradient(45deg, #e94057, #f27121);
  --handle-size: 28px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; overflow:hidden;}
body{
  background: var(--bg);
  color: #fff;
  -webkit-font-smoothing:antialiased;
}
/* --- Landing Page Styles --- */
#landingPage {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: linear-gradient(45deg, #121828, #0a0e1a);
    transition: opacity 0.5s ease-out;
}
#createMemeBtn {
    font-size: 22px;
    font-weight: bold;
    padding: 18px 40px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    color: #fff;
    background: var(--gradient-btn);
    box-shadow: 0 10px 30px rgba(233, 64, 87, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
#createMemeBtn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(242, 113, 33, 0.4);
}

/* --- Main Editor Styles --- */
#mainEditor {
    display: flex;
    gap: 18px;
    align-items: flex-start;
    justify-content: center;
    padding: 18px;
    height: 100%;
    opacity: 0;
    transition: opacity 0.5s ease-in;
    visibility: hidden;
}
#mainEditor.visible {
    opacity: 1;
    visibility: visible;
}

.panel{
  width:360px;
  background: var(--panel);
  border-radius:12px;
  padding:14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.04);
  max-height: calc(100vh - 36px);
  overflow:auto;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
}
h1{font-size:20px;margin:0 0 12px 0; display:flex; gap:8px; align-items:center}
h1 img.site-logo{width:40px;height:40px;object-fit:contain;border-radius:8px}
.muted{opacity:0.8; font-size:13px}
label{display:block;margin-top:10px;font-size:13px;color:#e6eefb; font-weight: 500;}

.btn{
  background: var(--gradient-btn);
  color:#fff;border:0;padding:10px 12px;border-radius:8px;
  cursor:pointer;margin-top:10px;font-weight:600;width:100%;
  box-shadow:0 6px 20px rgba(233, 64, 87, 0.2);
}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.2);width:auto;padding:8px 10px}
.templates{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tpl{
  width:70px;height:70px;border-radius:8px;overflow:hidden;border:2px solid transparent;cursor:pointer;
  display:flex;align-items:center;justify-content:center;background:#0b1220;
}
.tpl img{display:block;max-width:100%;max-height:100%;object-fit:contain}
.tpl.selected{border-color:var(--accent);box-shadow:0 6px 20px rgba(242, 113, 33, 0.2)}
.stage-wrap{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
  width: 100%;
  max-width: 664px;
}
#stage{
  width:100%; aspect-ratio:1/1;
  background:#111;border-radius:6px;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  touch-action: none;
}
.element{
  position:absolute;cursor:move;user-select:none;
  display:flex;align-items:center;justify-content:center;
  transform-origin:center center;
  touch-action:none;
  padding: 8px;
  border: 2px dashed transparent;
  transition: border-color 0.2s;
}
.element.selected{ border-color: var(--accent); }
.element img{ width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
.text-element{
  text-align:center;
  white-space:nowrap;
  font-family: 'Impact', sans-serif;
  font-weight: 900;
  text-transform: uppercase;
  font-size: 50px; /* Base font size */
}
.control, select.control, input.control[type="number"]{
  background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);
  font-size:14px;color:#eaf4ff; width: 100%;
}
select.control {
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    padding-right: 30px;
}
.hidden-control { display: none !important; }

/* Stylish File Input */
.file-input-wrapper { margin-top: 8px; }
.file-input-label {
    background-color: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; padding: 10px 15px;
    cursor: pointer; display: block; text-align: center;
    transition: background-color 0.2s;
}
.file-input-label:hover { background-color: rgba(255,255,255,0.1); }
input[type="file"] { display: none; }

/* New Rotation Handle */
.rotate-handle {
    position: absolute;
    width: var(--handle-size); height: var(--handle-size);
    background: #222; border: 2px solid #fff;
    border-radius: 50%; z-index: 100;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    bottom: calc(var(--handle-size) * -0.75);
    left: 50%; transform: translateX(-50%);
    cursor: grab; display: none;
    align-items: center; justify-content: center;
}
.rotate-handle::after {
    content: '';
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    position: absolute;
    top: 2px;
}
.element.selected .rotate-handle { display: flex; }
.rotate-handle:active { cursor: grabbing; }

/* Size Controls */
.size-controls {
  display: flex; align-items: center;
  gap: 10px; margin-top: 8px;
}
.size-controls input[type="range"] { flex-grow: 1; }
.size-controls input[type="number"] {
    width: 70px;
    text-align: center;
    -moz-appearance: textfield;
}
.size-controls input[type="number"]::-webkit-outer-spin-button,
.size-controls input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Footer */
.panel-footer {
    margin-top: auto; padding-top: 15px; text-align: center;
    font-size: 11px; color: #a0aec0; opacity: 0.8;
}

/* Mobile Responsive */
@media (max-width:980px){
  html, body { overflow: auto; }
  #mainEditor {
      flex-direction:column; align-items:center;
      padding: 10px; gap: 10px;
      height: auto;
  }
  .panel, .stage-wrap {
      width:100%; max-width: 100%;
  }
  .panel { max-height: none; order: 2; flex-shrink: 1; }
  .stage-wrap { order: 1; }
}
</style>
</head>
<body>

<div id="landingPage">
    <button id="createMemeBtn">Create A Meme</button>
</div>

<div id="mainEditor">
    <div class="panel">
        <div> <!-- Main controls wrapper -->
            <h1>
                <img class="site-logo" src="https://i.postimg.cc/QVZ3YY8M/Picsart-25-09-03-16-47-56-184.png" alt="MemeLee logo">
                MemeLee <span class="muted">— Pixel Perfect</span>
            </h1>

            <label>Template</label>
            <div class="templates" id="templates"></div>
            
            <label>Background Image</label>
            <div class="file-input-wrapper">
                <label for="uploadInput" class="file-input-label">Choose Background</label>
                <input id="uploadInput" type="file" accept="image/*">
            </div>

            <label style="margin-top:12px">Add Image Layer</label>
            <div class="file-input-wrapper">
                <label for="addImageInput" class="file-input-label">Choose Layer</label>
                <input id="addImageInput" type="file" accept="image/*">
            </div>

            <label style="margin-top:12px">Add Text</label>
            <div style="display:flex;gap:8px;">
                <input id="textInput" class="control" placeholder="Write something..." />
                <button id="addTextBtn" class="btn secondary" style="width: auto; flex-shrink: 0;">Add</button>
            </div>

            <!-- Controls for selected element -->
            <div id="elementControls" class="hidden-control">
                <label style="margin-top:12px">Size</label>
                <div class="size-controls">
                    <input id="sizeSlider" type="range" min="0.2" max="5" value="1" step="0.01">
                    <input id="sizeInput" type="number" class="control" min="0.2" max="5" step="0.1" value="1">
                </div>

                <div id="textOnlyControls">
                    <label style="margin-top:12px">Font Style</label>
                    <select id="fontSelector" class="control">
                        <option value="Impact, sans-serif">Impact (White)</option>
                        <option value="Anton, sans-serif">Anton (Yellow)</option>
                        <option value="'Arial Black', sans-serif">Arial Black (Green)</option>
                        <option value="'Montserrat', sans-serif">Montserrat (Red)</option>
                    </select>
                </div>
                
                <label style="margin-top:12px">Actions</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <button id="bringFront" class="btn secondary small control">Bring Forward</button>
                    <button id="deleteEl" class="btn secondary small control">Delete</button>
                </div>
            </div>

            <button id="downloadBtn" class="btn" style="margin-top:14px">Download PNG</button>
        </div>
        <footer class="panel-footer">
            © 2025 MemeLee Generator - Powered By Superlee Agent.
        </footer>
    </div>

    <div class="stage-wrap">
        <div id="stage">
            <div id="canvasArea" style="position:relative;width:100%;height:100%;">
                <img id="bgImage" src="" style="width:100%;height:100%;object-fit:contain;border-radius:4px;display:block" alt="">
            </div>
        </div>
    </div>
</div>

<script>
// ---------- DOM Refs ----------
const landingPage = document.getElementById('landingPage');
const createMemeBtn = document.getElementById('createMemeBtn');
const mainEditor = document.getElementById('mainEditor');
const templatesWrap = document.getElementById('templates');
const uploadInput = document.getElementById('uploadInput');
const addImageInput = document.getElementById('addImageInput');
const bgImage = document.getElementById('bgImage');
const canvasArea = document.getElementById('canvasArea');
const addTextBtn = document.getElementById('addTextBtn');
const textInput = document.getElementById('textInput');
const fontSelector = document.getElementById('fontSelector');
const downloadBtn = document.getElementById('downloadBtn');
const bringFrontBtn = document.getElementById('bringFront');
const deleteElBtn = document.getElementById('deleteEl');
const elementControls = document.getElementById('elementControls');
const textOnlyControls = document.getElementById('textOnlyControls');
const sizeSlider = document.getElementById('sizeSlider');
const sizeInput = document.getElementById('sizeInput');

let selectedEl = null;
let elements = [];

// ---------- Font Style Definitions ----------
const fontStyles = {
    "Impact, sans-serif": { color: '#FFFFFF', stroke: '#000000', weight: '900' },
    "Anton, sans-serif": { color: '#FFFF00', stroke: '#000000', weight: '900' },
    "'Arial Black', sans-serif": { color: '#00FF00', stroke: '#000000', weight: '900' },
    "'Montserrat', sans-serif": { color: '#FF0000', stroke: '#000000', weight: '900' }
};

// ---------- Templates ----------
const templates = [
  { id: 'tpl1', src: 'https://i.postimg.cc/tRZ9yWV5/1756892237569.png', name: 'Template 1' },
  { id: 'tpl2', src: 'https://i.postimg.cc/c1p0JCRN/1756892655850.png', name: 'Template 2' },
  { id: 'tpl3', src: 'https://i.postimg.cc/SNcqY4dY/1756892807860.png', name: 'Template 3' },
  { id: 'tpl4', src: 'https://i.postimg.cc/K4Sqhd3d/1756893169751.png', name: 'Template 4' }
];

templates.forEach((t,i)=>{
  const d = document.createElement('div');
  d.className = 'tpl' + (i===0? ' selected':'');
  const img = document.createElement('img'); img.src = t.src;
  d.appendChild(img);
  d.addEventListener('click', ()=> {
    document.querySelectorAll('.tpl').forEach(x=>x.classList.remove('selected'));
    d.classList.add('selected');
    bgImage.src = t.src;
  });
  templatesWrap.appendChild(d);
  if(i===0){ bgImage.src = t.src; }
});

// ---------- App Initialization ----------
createMemeBtn.addEventListener('click', () => {
    landingPage.style.opacity = '0';
    setTimeout(() => {
        landingPage.style.display = 'none';
        mainEditor.classList.add('visible');
    }, 500);
});

// ---------- Element Creation & Styling ----------
function createElement(type, options) {
    const el = document.createElement('div');
    el.className = 'element';
    
    const obj = {
        id: 'el' + Date.now() + Math.random(), type, el,
        x: options.x || 50, y: options.y || 50,
        width: options.width || (type === 'text' ? 350 : 250), 
        height: options.height || (type === 'text' ? 80 : 150),
        rotation: 0, scale: 1, z: elements.length + 1,
    };
    
    if (type === 'text') {
        el.classList.add('text-element');
        obj.content = options.content || 'Sample Text';
        obj.fontFamily = 'Impact, sans-serif';
        el.textContent = obj.content;
    } else {
        const img = document.createElement('img');
        img.src = options.src;
        el.appendChild(img);
    }
    
    const rotateHandle = document.createElement('div');
    rotateHandle.className = 'rotate-handle';
    el.appendChild(rotateHandle);

    el.style.zIndex = obj.z;
    makeInteractive(obj);
    updateElementTransform(obj);
    
    canvasArea.appendChild(el);
    elements.push(obj);
    selectElement(obj);
}

function updateElementTransform(elObj) {
    const el = elObj.el;
    el.style.left = `${elObj.x}px`;
    el.style.top = `${elObj.y}px`;
    el.style.width = `${elObj.width}px`;
    el.style.height = `${elObj.height}px`;
    el.style.transform = `rotate(${elObj.rotation}deg) scale(${elObj.scale})`;
    if (elObj.type === 'text') {
        const style = fontStyles[elObj.fontFamily];
        el.style.fontFamily = elObj.fontFamily;
        el.style.fontWeight = style.weight;
        el.style.color = style.color;
        el.style.webkitTextStroke = `1.5px ${style.stroke}`;
        el.style.fontSize = `${elObj.height * 0.7}px`;
    }
}

// ---------- Interactivity (Drag & Rotate) ----------
function makeInteractive(obj) {
    const { el } = obj;
    let mode = '';
    let startX, startY, center, startAngle, startRotation;

    function onPointerDown(e) {
        if(e.button !== 0) return;
        e.stopPropagation();
        selectElement(obj);
        
        const target = e.target;
        if (target.classList.contains('rotate-handle')) {
            mode = 'rotate';
            const rect = el.getBoundingClientRect();
            center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x);
            startRotation = obj.rotation;
        } else {
            mode = 'move';
            startX = e.clientX - obj.x;
            startY = e.clientY - obj.y;
        }
        
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
    }

    function onPointerMove(e) {
        if (mode === 'move') {
            obj.x = e.clientX - startX;
            obj.y = e.clientY - startY;
        } else if (mode === 'rotate') {
            const currentAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x);
            const angleDiff = currentAngle - startAngle;
            obj.rotation = Math.round(startRotation + angleDiff * (180 / Math.PI));
        }
        updateElementTransform(obj);
    }

    function onPointerUp() {
        mode = '';
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
    }
    
    el.addEventListener('pointerdown', onPointerDown);

    if (obj.type === 'text') {
        el.addEventListener('dblclick', () => {
            const newText = prompt('Edit text:', obj.content);
            if (newText !== null && newText.trim() !== '') {
                obj.content = newText;
                el.textContent = newText;
            }
        });
    }
}

// ---------- Selection & Controls ----------
function selectElement(objToSelect) {
    if (selectedEl === objToSelect) return;
    deselectAll();
    selectedEl = objToSelect;
    selectedEl.el.classList.add('selected');
    elementControls.classList.remove('hidden-control');
    
    sizeSlider.value = selectedEl.scale;
    sizeInput.value = selectedEl.scale;
    
    textOnlyControls.style.display = selectedEl.type === 'text' ? 'block' : 'none';
    if (selectedEl.type === 'text') {
        fontSelector.value = selectedEl.fontFamily;
    }
}

function deselectAll() {
    if (selectedEl) {
        selectedEl.el.classList.remove('selected');
    }
    selectedEl = null;
    elementControls.classList.add('hidden-control');
}

// ---------- Event Listeners ----------
function handleSizeChange(newSize) {
    if (selectedEl) {
        selectedEl.scale = parseFloat(newSize);
        updateElementTransform(selectedEl);
    }
}
sizeSlider.addEventListener('input', (e) => {
    sizeInput.value = e.target.value;
    handleSizeChange(e.target.value);
});
sizeInput.addEventListener('input', (e) => {
    const val = Math.max(0.2, Math.min(5, parseFloat(e.target.value) || 1));
    sizeSlider.value = val;
    handleSizeChange(val);
});

fontSelector.addEventListener('input', () => {
    if (selectedEl && selectedEl.type === 'text') {
        selectedEl.fontFamily = fontSelector.value;
        updateElementTransform(selectedEl);
    }
});

addTextBtn.addEventListener('click', () => {
    createElement('text', { content: textInput.value || 'Hello World' });
    textInput.value = '';
});

addImageInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            // **FIX STARTS HERE: Calculate aspect ratio before creating element**
            const imgSrc = ev.target.result;
            const img = new Image();
            img.onload = () => {
                const aspectRatio = img.naturalWidth / img.naturalHeight;
                const initialWidth = 250; // A sensible default width
                const initialHeight = initialWidth / aspectRatio;
                createElement('image', {
                    src: imgSrc,
                    width: initialWidth,
                    height: initialHeight
                });
            };
            img.src = imgSrc;
            // **FIX ENDS HERE**
        };
        reader.readAsDataURL(e.target.files[0]);
    }
    e.target.value = '';
});

uploadInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
        bgImage.src = URL.createObjectURL(e.target.files[0]);
    }
});

deleteElBtn.addEventListener('click', () => {
    if (selectedEl) {
        canvasArea.removeChild(selectedEl.el);
        elements = elements.filter(e => e.id !== selectedEl.id);
        deselectAll();
    }
});

bringFrontBtn.addEventListener('click', () => {
    if (selectedEl) {
        const maxZ = Math.max(0, ...elements.map(e => e.z));
        selectedEl.z = maxZ + 1;
        selectedEl.el.style.zIndex = selectedEl.z;
    }
});

canvasArea.addEventListener('click', (e) => {
    if (e.target === canvasArea || e.target === bgImage) {
        deselectAll();
    }
});

// ---------- Download ----------
async function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err);
        img.src = src;
    });
}

downloadBtn.addEventListener('click', async () => {
    deselectAll();
    await new Promise(r => setTimeout(r, 100));
    await document.fonts.ready;

    const outSize = 1200;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const stageRect = stage.getBoundingClientRect();
    canvas.width = outSize;
    canvas.height = outSize * (stageRect.height / stageRect.width);
    const scaleFactor = canvas.width / stageRect.width;

    try {
        const img = await loadImage(bgImage.src);
        const imgRatio = img.width / img.height;
        const canvasRatio = canvas.width / canvas.height;
        let dw, dh, dx, dy;
        if (imgRatio > canvasRatio) {
            dw = canvas.width; dh = dw / imgRatio; dx = 0; dy = (canvas.height - dh) / 2;
        } else {
            dh = canvas.height; dw = dh * imgRatio; dy = 0; dx = (canvas.width - dw) / 2;
        }
        ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, dx, dy, dw, dh);
    } catch (e) { console.error("BG image error:", e); }

    const sortedElements = elements.slice().sort((a, b) => a.z - b.z);
    for (const el of sortedElements) {
        ctx.save();
        const centerX = (el.x + el.width / 2) * scaleFactor;
        const centerY = (el.y + el.height / 2) * scaleFactor;
        ctx.translate(centerX, centerY);
        ctx.rotate(el.rotation * Math.PI / 180);
        
        // Use the element's own scale property for drawing
        const finalWidth = el.width * el.scale * scaleFactor;
        const finalHeight = el.height * el.scale * scaleFactor;

        if (el.type === 'text') {
            ctx.scale(el.scale, el.scale); // Apply scale for text rendering context
            const style = fontStyles[el.fontFamily];
            const fontFamily = el.fontFamily.split(',')[0].replace(/'/g, "");
            const fontSize = el.height * 0.7 * scaleFactor;
            ctx.font = `${style.weight} ${fontSize}px "${fontFamily}", "Arial Black"`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.lineWidth = 2.5 * (fontSize / 50); // Proportional stroke
            ctx.strokeStyle = style.stroke;
            ctx.strokeText(el.content.toUpperCase(), 0, 0);
            ctx.fillStyle = style.color;
            ctx.fillText(el.content.toUpperCase(), 0, 0);
        } else if (el.type === 'image') {
            const img = await loadImage(el.el.querySelector('img').src);
            ctx.drawImage(img, -finalWidth / 2, -finalHeight / 2, finalWidth, finalHeight);
        }
        ctx.restore();
    }
    
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    ctx.font = `bold ${16 * scaleFactor}px Arial`;
    ctx.textAlign = 'right';
    ctx.fillText('Made with MemeLee', canvas.width - (10 * scaleFactor), canvas.height - (10 * scaleFactor));

    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'memelee-pixel-perfect.png';
    a.click();
});
</script>
</body>
</html>
